;window.BWU=window.BWU||{};(function(e,i,t,s,u){var n,a,d;if(!s){console.warn('Missing ajaxurl value.');return};if(!('EventSource' in window)){console.warn('Event Source does not exist in this browser');return};function r(){this.closeEventSource();this.cleanUi();this.decrypter&&this.decrypter.destruct()};function o(e){if(!e){return};e.style.display='none'};function c(e){if(!e){return};e.style.display='block'};d={showWaitingMessage:function(){c(this.waitingUi)},showProgressUi:function(){c(this.progressUi)},showSuccessMsg:function(){c(this.successUi)},hideWaitingMessage:function(){o(this.waitingUi)},hideProgressUi:function(){o(this.progressUi)},hideNotice:function(){t.Functions.removeMessages(this.containerUi)},hideSuccessMsg:function(){o(this.successUi)},cleanUi:function(){this.hideWaitingMessage();this.hideProgressUi();this.hideNotice();this.hideSuccessMsg();this.decrypter&&this.decrypter.hide()},done:function(){this.showSuccessMsg();window.location.href=this.currentTarget.dataset.url;setTimeout(u,3000)},onMessage:function(i){var s;try{s=JSON.parse(i.data);switch(s.state){case t.States.DOWNLOADING:this.cleanUi();this.showProgressUi();e('#progresssteps').css({width:s.download_percent+'%'}).text(s.download_percent+'%');break;case t.States.DONE:this.done(s.message);break}}catch(n){t.Functions.printMessageError(n.message,this.containerUi);r.call(this)}},onError:function(e){var i=JSON.parse(e.data);this.closeEventSource();switch(i.message){case t.States.NEED_DECRYPTION_KEY:this.cleanUi();this.decrypter&&this.decrypter.needDecryption(i.status);break;default:t.Functions.printMessageError(i.message,this.containerUi);r.call(this);break};return this},initializeEventSource:function(){if(!i.isUndefined(this.eventSource)){return};this.eventSource=new EventSource(s+'?action=download_backup_file&destination='+this.currentTarget.dataset.destination+'&jobid='+this.currentTarget.dataset.jobid+'&file='+this.currentTarget.dataset.file+'&local_file='+this.currentTarget.dataset.localFile+'&backwpup_action_nonce='+this.currentTarget.dataset.nonce);this.eventSource.onmessage=this.onMessage;this.eventSource.addEventListener('log',this.onError)},closeEventSource:function(){if(i.isUndefined(this.eventSource)){return};this.eventSource.close();this.eventSource=undefined},startDownload:function(e){e.preventDefault();this.currentTarget=e.target;this.showWaitingMessage();this.initializeEventSource()},decrypt:function(){this.cleanUi();this.decrypter&&this.decrypter.decrypt({backwpup_action_nonce:this.currentTarget.dataset.nonce,encrypted_file_path:this.currentTarget.dataset.localFile})},construct:function(e){var t=document.querySelector('#tb_container');if(!t){return!1};i.bindAll(this,'showWaitingMessage','hideWaitingMessage','showProgressUi','hideSuccessMsg','showSuccessMsg','done','onMessage','onError','initializeEventSource','closeEventSource','startDownload','addListeners','decrypt','hideNotice','cleanUi','init');this.containerUi=t;this.waitingUi=this.containerUi.querySelector('#download-file-waiting');this.progressUi=this.containerUi.querySelector('.progressbar');this.successUi=this.containerUi.querySelector('#download-file-success');this.currentTarget=undefined;this.eventSource=undefined;this.decrypter=e;return this},addListeners:function(){i.forEach(document.querySelectorAll('.backup-download-link'),function(e){e.addEventListener('click',this.startDownload)}.bind(this));e('#submit_decrypt_key').on('click',this.decrypt);e('body').on('thickbox:removed',function(){r.call(this)}.bind(this));if(this.decrypter){e('body').on(this.decrypter.ACTION_DECRYPTION_SUCCESS,this.done)}
else{};return this},init:function(){this.addListeners();return this}};n=Object.create(d);if(!i.isUndefined(t.DecrypterFactory)){a=t.DecrypterFactory(s,document.querySelector('#decrypt_key'),document.querySelector('#decryption_key'))};if(n.construct(a)){n.init()}}(window.jQuery,window._,window.BWU,window.ajaxurl,window.tb_remove));